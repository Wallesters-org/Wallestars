name: Test Integrations

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  test-python-integrations:
    name: Test Python Integrations
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install pytest requests
      
      - name: Test 33mail Manager
        run: |
          echo "ðŸ§ª Testing 33mail integration..."
          python platforms/33mail-integration/33mail-manager.py generate test-ci "CI test email"
          python platforms/33mail-integration/33mail-manager.py list
      
      - name: Test VPS Manager (dry run)
        env:
          VPS_HOST: srv1201204.hstgr.cloud
          VPS_IP: 72.61.154.188
        run: |
          echo "ðŸ§ª Testing VPS manager..."
          # Test without SSH connection (dry run)
          python -c "from platforms.hostinger_vps.hostinger_vps_manager import HostingerVPSManager; m = HostingerVPSManager(); print(m.vps_host)"
      
      - name: Test Multi-Agent Orchestrator
        run: |
          echo "ðŸ§ª Testing Multi-Agent Orchestrator..."
          python shared/orchestrator/multi-agent-orchestrator.py

  test-node-integrations:
    name: Test Node.js Integrations
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm install
          
          # Install Eva Core dependencies
          if [ -d "eva-core" ]; then
            cd eva-core
            npm install
            cd ..
          fi
      
      - name: Test Eva Core
        run: |
          echo "ðŸ§ª Testing Eva Core..."
          cd eva-core
          
          # Run demo without API keys (dry run)
          export CLAUDE_API_KEY="test-key"
          export OPENAI_API_KEY="test-key"
          
          # Test imports
          node -e "const EvaCore = require('./src/index.js'); console.log('âœ… Eva Core imports successfully')"
      
      - name: Lint JavaScript
        run: |
          if command -v eslint &> /dev/null; then
            echo "Running ESLint..."
            npm run lint || true
          fi

  test-workflows:
    name: Test n8n Workflows
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate JSON Workflows
        run: |
          echo "ðŸ§ª Validating n8n workflows..."
          
          for workflow in workflows/*.json eva-core/workflows/*.json; do
            if [ -f "$workflow" ]; then
              echo "Validating $workflow..."
              if python -m json.tool "$workflow" > /dev/null 2>&1; then
                echo "âœ… $workflow is valid JSON"
              else
                echo "âŒ $workflow is invalid JSON"
                exit 1
              fi
            fi
          done
      
      - name: Check Workflow Completeness
        run: |
          echo "ðŸ§ª Checking workflow completeness..."
          
          # Check that workflows have required fields
          for workflow in workflows/*.json; do
            if [ -f "$workflow" ]; then
              echo "Checking $workflow..."
              
              # Check for nodes
              if ! grep -q '"nodes"' "$workflow"; then
                echo "âš ï¸  $workflow missing nodes"
              fi
              
              # Check for connections
              if ! grep -q '"connections"' "$workflow"; then
                echo "âš ï¸  $workflow missing connections"
              fi
            fi
          done

  test-vps-connectivity:
    name: Test VPS Connectivity
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Test VPS Ping
        run: |
          echo "ðŸ§ª Testing VPS connectivity..."
          
          VPS_IP="72.61.154.188"
          VPS_HOST="srv1201204.hstgr.cloud"
          
          # Ping test
          if ping -c 3 $VPS_IP > /dev/null 2>&1; then
            echo "âœ… VPS IP $VPS_IP is reachable"
          else
            echo "âš ï¸  VPS IP $VPS_IP is not reachable"
          fi
          
          # DNS resolution
          if nslookup $VPS_HOST > /dev/null 2>&1; then
            echo "âœ… VPS hostname $VPS_HOST resolves"
          else
            echo "âš ï¸  VPS hostname $VPS_HOST doesn't resolve"
          fi
      
      - name: Test n8n Service
        run: |
          echo "ðŸ§ª Testing n8n service..."
          
          N8N_URL="https://n8n.srv1201204.hstgr.cloud"
          
          # Check if n8n is accessible
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" $N8N_URL || echo "000")
          
          if [ "$STATUS" = "200" ] || [ "$STATUS" = "401" ]; then
            echo "âœ… n8n service is accessible (HTTP $STATUS)"
          else
            echo "âš ï¸  n8n service returned HTTP $STATUS"
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Scan for secrets
        run: |
          echo "ðŸ”’ Scanning for exposed secrets..."
          
          # Check for common secret patterns
          if grep -r "sk-ant-" --exclude-dir=.git . 2>/dev/null | grep -v ".env.example" | grep -v "README"; then
            echo "âŒ Found exposed Anthropic API key"
            exit 1
          fi
          
          if grep -r "sk-proj-" --exclude-dir=.git . 2>/dev/null | grep -v ".env.example" | grep -v "README"; then
            echo "âŒ Found exposed OpenAI API key"
            exit 1
          fi
          
          if grep -r "ghp_" --exclude-dir=.git . 2>/dev/null | grep -v ".env.example" | grep -v "README"; then
            echo "âŒ Found exposed GitHub token"
            exit 1
          fi
          
          echo "âœ… No exposed secrets found"
      
      - name: Check .env.example
        run: |
          echo "ðŸ”’ Validating .env.example..."
          
          if [ -f ".env.example" ]; then
            # Check that example doesn't contain real values
            if grep -E "sk-ant-[a-zA-Z0-9]{32,}" .env.example; then
              echo "âŒ .env.example contains real Anthropic key"
              exit 1
            fi
            
            if grep -E "sk-proj-[a-zA-Z0-9]{32,}" .env.example; then
              echo "âŒ .env.example contains real OpenAI key"
              exit 1
            fi
            
            echo "âœ… .env.example is safe"
          fi

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-python-integrations, test-node-integrations, test-workflows, security-scan]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test-python-integrations.result }}" = "success" ]; then
            echo "âœ… Python Integrations: **PASSED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Python Integrations: **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test-node-integrations.result }}" = "success" ]; then
            echo "âœ… Node.js Integrations: **PASSED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Node.js Integrations: **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test-workflows.result }}" = "success" ]; then
            echo "âœ… n8n Workflows: **PASSED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ n8n Workflows: **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.security-scan.result }}" = "success" ]; then
            echo "âœ… Security Scan: **PASSED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Security Scan: **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi
