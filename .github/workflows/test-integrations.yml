name: Test Integrations

on:
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'

jobs:
  test-integrations:
    runs-on: ubuntu-latest
    name: Test All Integrations
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install requests anthropic openai supabase pytest pytest-asyncio
      
      - name: Test 33mail Manager
        run: |
          echo "ðŸ“§ Testing 33mail Manager..."
          
          # Make executable
          chmod +x .devcontainer/integrations/33mail/33mail-manager.py
          
          # Test basic commands
          python3 .devcontainer/integrations/33mail/33mail-manager.py stats
          
          # Create test alias
          python3 .devcontainer/integrations/33mail/33mail-manager.py create test-github-actions "CI/CD test"
          
          # List aliases
          python3 .devcontainer/integrations/33mail/33mail-manager.py list
          
          # Get test alias
          python3 .devcontainer/integrations/33mail/33mail-manager.py get test-github-actions
          
          echo "âœ… 33mail Manager tests passed"
      
      - name: Test VPS Manager (network tests only)
        env:
          VPS_IP: 72.61.154.188
          VPS_HOSTNAME: srv1201204.hstgr.cloud
        run: |
          echo "ðŸ–¥ï¸ Testing VPS Manager (network tests)..."
          
          # Test ping
          ping -c 3 72.61.154.188 || echo "âš ï¸ Ping failed (may be blocked by firewall)"
          
          # Test HTTP endpoint
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://n8n.srv1201204.hstgr.cloud || echo "000")
          echo "n8n endpoint returned: HTTP $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ] || [ "$HTTP_CODE" = "401" ]; then
            echo "âœ… VPS is reachable"
          else
            echo "âš ï¸ VPS endpoint check inconclusive (HTTP $HTTP_CODE)"
          fi
      
      - name: Test Multi-Agent Orchestrator
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        if: ${{ secrets.ANTHROPIC_API_KEY != '' }}
        run: |
          echo "ðŸ¤– Testing Multi-Agent Orchestrator..."
          
          chmod +x .devcontainer/agents/multi-agent-orchestrator.py
          
          # Test stats (doesn't require API call)
          python3 .devcontainer/agents/multi-agent-orchestrator.py --stats
          
          # Test simple query (requires API key)
          if [ -n "$ANTHROPIC_API_KEY" ]; then
            python3 .devcontainer/agents/multi-agent-orchestrator.py "What is 2+2?" --verbose
            echo "âœ… Multi-Agent Orchestrator tests passed"
          else
            echo "âš ï¸ Skipping AI tests (no API key)"
          fi
      
      - name: Test helper scripts
        run: |
          echo "ðŸ”§ Testing helper scripts..."
          
          # Make helpers executable
          chmod +x .devcontainer/helpers/*
          
          # Test 33mail helper
          .devcontainer/helpers/33mail stats
          
          echo "âœ… Helper scripts tests passed"
      
      - name: Test Eva Core
        run: |
          echo "ðŸ§  Testing Eva Core..."
          
          cd eva-core
          
          if [ -f "package.json" ]; then
            npm install
            
            # Run tests if they exist
            if npm run test --if-present; then
              echo "âœ… Eva Core tests passed"
            else
              echo "âš ï¸ No tests found for Eva Core"
            fi
          else
            echo "âš ï¸ No package.json found in eva-core"
          fi
      
      - name: Validate configuration files
        run: |
          echo "ðŸ“‹ Validating configuration files..."
          
          # Check docker-compose.yml syntax
          if command -v docker-compose &> /dev/null; then
            docker-compose -f docker-compose.yml config > /dev/null
            echo "âœ… docker-compose.yml is valid"
          fi
          
          # Check JSON files
          for file in $(find . -name "*.json" -not -path "*/node_modules/*"); do
            if python3 -m json.tool "$file" > /dev/null 2>&1; then
              echo "âœ… $file is valid JSON"
            else
              echo "âŒ $file is invalid JSON"
              exit 1
            fi
          done
          
          echo "âœ… All configuration files valid"
      
      - name: Check documentation
        run: |
          echo "ðŸ“š Checking documentation..."
          
          # Check that key docs exist
          REQUIRED_DOCS=(
            "README.md"
            "docs/FULL-ARCHITECTURE.md"
            ".devcontainer/INTEGRATIONS-GUIDE.md"
          )
          
          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ -f "$doc" ]; then
              echo "âœ… $doc exists"
            else
              echo "âŒ $doc is missing"
              exit 1
            fi
          done
          
          echo "âœ… All required documentation present"
      
      - name: Generate test report
        if: always()
        run: |
          echo "# Integration Tests Report" > test-report.md
          echo "" >> test-report.md
          echo "**Date:** $(date)" >> test-report.md
          echo "**Branch:** ${{ github.ref_name }}" >> test-report.md
          echo "**Commit:** ${{ github.sha }}" >> test-report.md
          echo "" >> test-report.md
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **Status:** All tests passed" >> test-report.md
          else
            echo "âŒ **Status:** Some tests failed" >> test-report.md
          fi
          
          echo "" >> test-report.md
          echo "## Tested Components" >> test-report.md
          echo "- 33mail Manager" >> test-report.md
          echo "- VPS Manager (network tests)" >> test-report.md
          echo "- Multi-Agent Orchestrator" >> test-report.md
          echo "- Helper scripts" >> test-report.md
          echo "- Configuration files" >> test-report.md
          echo "- Documentation" >> test-report.md
          
          cat test-report.md
      
      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: test-report.md
      
      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('test-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
